# Batch-режим чтения данных из Битрикс24

## Описание задачи

В CRM у сущности более 100 000 элементов, требуется получить эти данные в клиентском коде. У сущности добавлены пользовательские поля,
порядка десяти штук, разного типа.

В зависимости от ситуации перед разработчиком может стоять задача:

- получить полный набор полей сущности, например, для выгрузки в аналитическую систему;
- получить отдельные поля сущности;
- по умолчанию, при выборке производится подсчёт количества элементов в выборке, на больших объёмах это дорогостоящая операция, если
  передать флаг count=-1, то подсчёт элементов можно отключить

## Документация и примечания

https://dev.1c-bitrix.ru/rest_help/general/batch.php

- По умолчанию, за 1 запрос `crm.contacts.lists` возвращается 50 элементов.
- батч-запрос может выполнить до 50 запросов, т.е. за один батч-запрос можно получить 2500 элементов

## Тестирование быстродействия

Предусловия:

- облачный Битрикс24
- количество сущностей одного типа в CRM — 100 000 штук.
- BITRIX24-PHP-SDK запускается на машине разработчика
- работаем с сущностью `crm.contacts`

### Параметры получения данных

**order**

- `default`: сущность по которой будет производится сортировка и направление сортировки не передаются
- `custom`: `DATE_CREATE=>ASC`

**filter**

- полная выборка `'>ID' => 1`;
- данные за период (фильтр по дате создания)

**select**

- частичная (`partial`) выборка полей сущности: `ID`, `NAME`, `LAST_NAME`, `DATE_CREATE`, `PHONE`, `EMAIL`
- системные поля (`system`) cущности: `*`, `PHONE`, `EMAIL`, `IM`
- все поля (`all`) сущности: `*`, `PHONE`, `EMAIL`, `IM`, `UF_*`

### Запуск тестового кода

Код замера лежит в папке `tools\PerformanceBenchmarks\`, запускается как CLI-команда.

```shell
mesilov@mesilov-local bitrix24-php-sdk % php -d memory_limit=500M -f tools/bin/console benchmark:list -help
Description:
  performance benchmark for *.list method

Usage:
  benchmark:list [options]

Options:
      --webhook=WEBHOOK  bitrix24 incoming webhook [default: ""]
      --rounds=ROUNDS    benchmark rounds count [default: 3]
      --fields=FIELDS    select fields mode (partial | system | all) [default: "all"]
      --count=COUNT      read elements count [default: 50]
  -h, --help             Display help for the given command. When no command is given display help for the list command
  -q, --quiet            Do not output any message
  -V, --version          Display this application version
      --ansi             Force ANSI output
      --no-ansi          Disable ANSI output
  -n, --no-interaction   Do not ask any interactive question
  -v|vv|vvv, --verbose   Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug

Help:
  performance benchmark for *.list method with simple or batch mode if need read more than 50 elements
```

### Варианты выборки

1. сортировка, подсчёт количества элементов в выборке
2. сортировка, без подсчёта количества элементов в выборке
3. сортировка по умолчанию, подсчёт количества элементов в выборке
4. сортировка по умолчанию, без подсчёта количества элементов в выборке

### Чтение 50 элементов — отдельные поля \ вся сущность \ вся сущность + пользовательские поля

Стандартная выборка 50 элементов приведена для сравнения с батч-режимом. Время — секунды, округление до 4 знаков.

Режим |  отдельные поля |  вся сущность | вся сущность + UF_*
--- | --- | --- | --- 
сортировка, подсчёт количества элементов в выборке | 0.1724 | 1.9875 | 2.3136
сортировка, без подсчёта количества элементов в выборке | 0.1173 |  1.3289  |  1.476
сортировка по умолчанию, подсчёт количества элементов в выборке | 0.0936 |  0.926 | 1.0272
сортировка по умолчанию, без подсчёта количества элементов в выборке | 0.0362 | 0.2701 | 0.2688

### Чтение 6000 элементов — отдельные поля \ вся сущность \ вся сущность + пользовательские поля

В данном примере используются batch-запросы, которые выбирают данные чанками по 2500, 2500 и 1000 элементов. Сами батч запросы реализуются
сервисом `Bitrix24\SDK\Core\Batch` Время — секунды, округление до 4 знаков.

Режим |  отдельные поля |  вся сущность | вся сущность + UF_*
--- | --- | --- | --- 
сортировка, подсчёт количества элементов в выборке | 17.8018 | 239.8081 | 274.9921
сортировка, без подсчёта количества элементов в выборке | **not implemented** |  **not implemented**  |  **not implemented**
сортировка по умолчанию, подсчёт количества элементов в выборке | 8.2121 | 110.0122 |  125.7331
сортировка по умолчанию, без подсчёта количества элементов в выборке | **not implemented** | **not implemented** | **not implemented**

## Подготовка тестового окружения

Сгенерируйте тестовые контакты для вашего dev-окружения используя CLI-команду из папки tools
`generate:contacts`

## Комментарии

1. В текущей версии статьи в портале было 100к элементов в сущности, эта ситуация характерна для небольшого количества порталов
2. Замеры производились когда на портале отсутствовала операционная нагрузка характерная для рабочего дня
3. По возможности старайтесь избегать выборки всех данных
4. Сортировка данных при больших выборках тоже слишком дорогая операция
5. В roadmap SDK будет добавлена задача на поддержку batch-запросов в режиме «отключенный подсчёт количества» элементов, сейчас там
   указано **not implemented**
6. Замеры будут проведены для кейсов от 10к до 200к элементов с шагом 10к элементов.
7. В коробочной версии Битрикс24 показатели могут существенно отличаться 
